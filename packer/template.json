{
  "variables": {
    "puppet_role": "",
    "packagecloud_master_token": "{{env `PACKAGECLOUD_MASTER_TOKEN`}}",
    "installer_version": "",
    "source_ami": "",
    "ami_description": ""
  },
  "builders": [
    {
      "type":         "null",
      "name":         "vagrant",
      "ssh_host":     "127.0.0.1",
      "ssh_port":     "2222",
      "ssh_username": "vagrant",
      "ssh_password": "vagrant"
    },
    {
      "type": "amazon-chroot",
      "name": "amazon",
      "source_ami": "{{user `source_ami`}}",
      "ami_name": "talend-tic-{{user `puppet_role`}}-{{timestamp}}",
      "ami_description": "{{user `ami_description`}}",
      "tags": {
        "puppet_role": "{{user `puppet_role`}}",
        "installer_version": "{{user `installer_version`}}"
      }
    }
  ],
  "provisioners": [
    {
      "type": "shell-local",
      "command": "aws s3 cp s3://us-east-1-rd-tipaas-talend-com/yum-repos/system/noarch/yum-plugin-s3-iam-1.0.2-1.noarch.rpm {{template_dir}}/yum-plugin-s3-iam-1.0.2-1.noarch.rpm"
    },
    {
      "type": "file",
      "only": ["amazon"],
      "source": "{{template_dir}}/yum-plugin-s3-iam-1.0.2-1.noarch.rpm",
      "destination": "/tmp/yum-plugin-s3-iam-1.0.2-1.noarch.rpm"
    },
    {
      "type": "shell",
      "only": ["amazon"],
      "inline": [
        "rpm -Uv --replacepkgs /tmp/yum-plugin-s3-iam-1.0.2-1.noarch.rpm"
      ]
    },
    {
      "type": "shell",
      "override": {
        "vagrant": {
          "execute_command": "sudo -E sh '{{ .Path }}'"
        }
      },
      "inline": [
        "yum clean all",
        "rpm -Uv --replacepkgs http://yum.puppetlabs.com/puppetlabs-release-el-7.noarch.rpm",
        "yum install -y puppet python-pip python-devel policycoreutils-devel",
        "gem install aws-sdk hiera-eyaml hiera-eyaml-kms",
        "rm -rf /tmp/puppet"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "mkdir -p /tmp/puppet/hieradata"
      ]
    },
    {
      "type": "file",
      "source": "{{template_dir}}/../hieradata/",
      "destination": "/tmp/puppet/hieradata"
    },
    {
      "type": "shell",
      "inline": [
        "rm -rf /etc/yum.repos.d/centos-talend.repo"
      ]
    },
    {
      "type": "file",
      "source": "{{template_dir}}/centos-talend.repo",
      "destination": "/etc/yum.repos.d/centos-talend.repo"
    },
    {
      "type": "puppet-masterless",
      "prevent_sudo": "true",
      "staging_directory": "/tmp/puppet",
      "manifest_file": "{{template_dir}}/../manifests/site.pp",
      "module_paths": [
        "{{template_dir}}/../modules",
        "{{template_dir}}/../site"
      ],
      "hiera_config_path": "{{template_dir}}/../hiera.yaml",
      "extra_arguments": [
        "--confdir=/tmp/puppet"
      ],
      "facter": {
        "environment": "ami",
        "puppet_role": "{{user `puppet_role`}}",
        "packagecloud_master_token": "{{user `packagecloud_master_token`}}"
      }
    }
  ]
}
